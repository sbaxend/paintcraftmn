---
/** ---------- Types & props ---------- */
type Stage = {
  id: string;
  title: string;
  desc: string;
  img: string;
};

export interface Props {
  heading?: string;
  stages?: Stage[];
}

const {
  heading = "Our Proven Process",
  stages = [
    {
      id: "prep",
      title: "Prep & Protect",
      desc: "We carefully protect furniture & floors, then prep all surfaces for perfect paint adhesion.",
      img: "/prep-two.png",
    },
    {
      id: "paint",
      title: "Paint & Perfect",
      desc: "Expert application with premium paints for smooth, even coverage and flawless results.",
      img: "/perfect.png",
    },
    {
      id: "clean",
      title: "Clean & Inspect",
      desc: "Thorough clean-up and a detailed walkthrough to make sure you love every detail.",
      img: "/inspect.png",
    },
  ],
} = Astro.props as Props;
---

<section class="relative bg-gradient-to-b from-neutral-50 to-white py-20 md:py-32">
  <div class="mx-auto max-w-[1600px] px-4 md:px-6">
    
    <!-- Section Header -->
    <div class="text-center mb-12 md:mb-16">
      <h2 class="text-4xl md:text-5xl lg:text-6xl font-bold text-neutral-900 tracking-tight">
        {heading}
      </h2>
      <p class="mt-4 text-lg md:text-xl text-neutral-600 max-w-3xl mx-auto">
        Three simple steps to transform your space with professional results
      </p>
    </div>

    <!-- Slideshow Container -->
    <div class="relative">
      
      <!-- Main Bubble Slideshow - TALLER & FULLY ROUNDED -->
      <div id="process-slider" class="relative">
        
        <!-- Slides -->
        <div class="relative min-h-[500px] md:min-h-[600px] lg:min-h-[700px] rounded-3xl overflow-hidden shadow-2xl ring-1 ring-neutral-200/70">
          {stages.map((stage, index) => (
            <div 
              class={`process-slide absolute inset-0 transition-opacity duration-700 ease-in-out ${index === 0 ? 'opacity-100 z-10' : 'opacity-0 z-0'}`}
              data-index={index}
            >
              <!-- Background Image - FULLY ROUNDED -->
              <img 
                src={stage.img} 
                alt={stage.title}
                class="absolute inset-0 h-full w-full object-cover rounded-3xl"
                loading={index === 0 ? "eager" : "lazy"}
                decoding="async"
              />
              
              <!-- Gradient Overlay - FULLY ROUNDED -->
              <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/30 to-black/20 rounded-3xl"></div>

              <!-- Content Overlay -->
              <div class="relative z-10 h-full flex flex-col justify-end p-8 md:p-12 lg:p-16">
                <div class="max-w-3xl">
                  <!-- Step Badge -->
                  <div class="inline-flex items-center gap-2 rounded-full bg-[#C48356] px-4 py-2 mb-4 shadow-lg">
                    <span class="text-white font-bold text-sm">STEP {index + 1}</span>
                  </div>

                  <!-- Title -->
                  <h3 class="text-3xl md:text-5xl lg:text-6xl font-black text-white mb-4 drop-shadow-lg">
                    {stage.title}
                  </h3>

                  <!-- Description -->
                  <p class="text-base md:text-xl text-white/95 leading-relaxed max-w-2xl">
                    {stage.desc}
                  </p>
                </div>
              </div>
            </div>
          ))}
        </div>

        <!-- Navigation Arrows -->
        <button 
          id="prev-btn"
          class="absolute left-4 md:left-6 top-1/2 -translate-y-1/2 z-20 h-12 w-12 md:h-14 md:w-14 rounded-full bg-white/95 backdrop-blur-sm flex items-center justify-center hover:bg-white hover:scale-110 transition-all shadow-xl focus:outline-none focus-visible:ring-2 focus-visible:ring-[#C48356] focus-visible:ring-offset-2"
          aria-label="Previous step"
        >
          <svg class="h-6 w-6 text-neutral-900" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
          </svg>
        </button>

        <button 
          id="next-btn"
          class="absolute right-4 md:right-6 top-1/2 -translate-y-1/2 z-20 h-12 w-12 md:h-14 md:w-14 rounded-full bg-white/95 backdrop-blur-sm flex items-center justify-center hover:bg-white hover:scale-110 transition-all shadow-xl focus:outline-none focus-visible:ring-2 focus-visible:ring-[#C48356] focus-visible:ring-offset-2"
          aria-label="Next step"
        >
          <svg class="h-6 w-6 text-neutral-900" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
          </svg>
        </button>

        <!-- Dot Indicators -->
        <div class="absolute bottom-6 md:bottom-8 left-1/2 -translate-x-1/2 z-20 flex gap-2 pointer-events-none">
          {stages.map((_, index) => (
            <div
              class={`process-dot h-2.5 w-2.5 rounded-full bg-white/40 transition-all ${index === 0 ? 'bg-white w-8' : ''}`}
              data-index={index}
            ></div>
          ))}
        </div>
      </div>

      <!-- Progress Indicator -->
      <div class="mt-8 flex items-center justify-center gap-4 text-sm text-neutral-600">
        <span id="current-step" class="font-semibold text-[#C48356]">1</span>
        <span>/</span>
        <span>{stages.length}</span>
      </div>

    </div>

    <!-- Bottom CTA -->
    <div class="mt-16 text-center">
      <a 
        href="/contact" 
        class="inline-flex items-center justify-center rounded-full bg-[#C48356] px-8 py-4 text-lg font-semibold text-white shadow-lg hover:bg-[#B47347] hover:shadow-xl hover:scale-105 transition-all"
      >
        Start Your Project Today
        <svg class="ml-2 h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
        </svg>
      </a>
    </div>

  </div>
</section>

<script is:inline>
  (function() {
    const slides = document.querySelectorAll('.process-slide');
    const dots = document.querySelectorAll('.process-dot');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const currentStepEl = document.getElementById('current-step');
    
    if (!slides.length || !prevBtn || !nextBtn) return;

    let currentIndex = 0;
    let autoplayInterval = null;
    const totalSlides = slides.length;

    const updateSlide = (index) => {
      // Update slides
      slides.forEach((slide, i) => {
        if (i === index) {
          slide.classList.remove('opacity-0', 'z-0');
          slide.classList.add('opacity-100', 'z-10');
        } else {
          slide.classList.remove('opacity-100', 'z-10');
          slide.classList.add('opacity-0', 'z-0');
        }
      });

      // Update dots
      dots.forEach((dot, i) => {
        if (i === index) {
          dot.classList.remove('bg-white/40', 'w-2.5');
          dot.classList.add('bg-white', 'w-8');
        } else {
          dot.classList.remove('bg-white', 'w-8');
          dot.classList.add('bg-white/40', 'w-2.5');
        }
      });

      // Update step counter
      if (currentStepEl) {
        currentStepEl.textContent = String(index + 1);
      }

      currentIndex = index;
    };

    const nextSlide = () => {
      const next = (currentIndex + 1) % totalSlides;
      updateSlide(next);
    };

    const prevSlide = () => {
      const prev = (currentIndex - 1 + totalSlides) % totalSlides;
      updateSlide(prev);
    };

    const startAutoplay = () => {
      if (autoplayInterval) clearInterval(autoplayInterval);
      autoplayInterval = setInterval(nextSlide, 5000);
    };

    const stopAutoplay = () => {
      if (autoplayInterval) {
        clearInterval(autoplayInterval);
        autoplayInterval = null;
      }
    };

    // ONLY arrow buttons trigger slide changes
    prevBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      stopAutoplay();
      prevSlide();
      setTimeout(startAutoplay, 10000); // Resume after 10s
    });

    nextBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      stopAutoplay();
      nextSlide();
      setTimeout(startAutoplay, 10000); // Resume after 10s
    });

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') {
        stopAutoplay();
        prevSlide();
        setTimeout(startAutoplay, 10000);
      }
      if (e.key === 'ArrowRight') {
        stopAutoplay();
        nextSlide();
        setTimeout(startAutoplay, 10000);
      }
    });

    // Pause on hover
    const slider = document.getElementById('process-slider');
    if (slider) {
      slider.addEventListener('mouseenter', stopAutoplay);
      slider.addEventListener('mouseleave', startAutoplay);
    }

    // Start autoplay
    startAutoplay();
  })();

  (() => {
      const el = document.querySelector('#meta-bridge .reveal-up');
      if (!el) return;
      const onIntersect = (entries, obs) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            el.classList.add('is-visible');
            obs.unobserve(entry.target);
          }
        });
      };
      const io = new IntersectionObserver(onIntersect, {
        root: null,
        rootMargin: '0px 0px -15% 0px', // trigger a touch before center
        threshold: 0.1
      });
      io.observe(el);
    })();
</script>

<style>
  /* scroll-in animation (applies when .is-visible gets added) */
   .reveal-up {
      opacity: 0;
      transform: translateY(26px);
      transition: opacity .7s ease-out, transform .7s ease-out;
    }
    .reveal-up.is-visible {
      opacity: 1;
      transform: translateY(0);
    }
    /* accessibility: honor reduced motion */
    @media (prefers-reduced-motion: reduce) {
      .reveal-up, .reveal-up.is-visible {
        opacity: 1 !important;
        transform: none !important;
        transition: none !important;
      }
    }

  .process-slide {
    transition: opacity 700ms cubic-bezier(0.4, 0, 0.2, 1);
  }

  .process-dot {
    transition: all 300ms cubic-bezier(0.4, 0, 0.2, 1);
  }

  @media (prefers-reduced-motion: reduce) {
    .process-slide {
      transition-duration: 200ms;
    }
  }
</style>