---
export interface Partner {
  name: string;
  logo: string;
  href?: string;
  description?: string;
}

export interface Props {
  title?: string;
  subtitle?: string;
  partners?: Partner[];
  class?: string;
}

const {
  title = "Our Trusted Partners",
  subtitle = "Find your perfect color--with tools trusted by the pros",
  partners = [
    {
      name: "Sherwin-Williams",
      logo: "/SherwinWilliams.webp",
      href: "https://www.sherwin-williams.com/en-us/color/color-tools/color-visualizer",
      description: "Premium paints & coatings",
    },
    {
      name: "Benjamin Moore",
      logo: "/benjaminMoore.webp",
      href: "https://www.benjaminmoore.com/en-us/paint-colors",
      description: "Luxury color solutions",
    },
    {
      name: "Hirshfield's",
      logo: "/Hirschfields.png",
      href: "https://hirshfieldpaint.chameleonpower.com/#",
      description: "Local expertise since 1894",
    },
  ],
  class: className = "",
} = Astro.props as Props;
---

<section
  class={`relative overflow-x-hidden bg-gradient-to-b from-white to-neutral-50 pt-10 md:pt-14 pb-16 md:pb-24 ${className}`}
>
  <div class="mx-auto max-w-7xl px-6">
    {/* Header */}
    <div class="mb-10 text-center">
      <div class="mb-5 inline-flex items-center gap-2 rounded-full bg-[#C48356]/10 px-4 py-2">
        <svg class="h-5 w-5 text-[#C48356]" fill="currentColor" viewBox="0 0 20 20">
          <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" />
        </svg>
        <span class="text-sm font-semibold uppercase tracking-wider text-[#C48356]">
          Partnerships
        </span>
      </div>

      <h2 class="mb-3 text-4xl font-bold text-neutral-900 md:text-5xl">
        {title}
      </h2>

      {subtitle && (
        <p class="mx-auto mt-4 max-w-3xl text-xl text-neutral-600">
          {subtitle}
        </p>
      )}
    </div>

    {/* Partner Cards Grid */}
    <div
      id="partners-grid"
      class="grid grid-cols-2 gap-4 sm:gap-6 md:grid-cols-3 md:gap-8 lg:gap-12"
    >
      {partners.map((partner, index) => {
        // Mobile layout: if exactly 3 cards, make the 3rd one span full row (2 columns)
        const isThirdOfThree = partners.length === 3 && index === 2;

        return (
          <a
            href={partner.href ?? "#"}
            target="_blank"
            rel="noopener noreferrer"
            aria-label={partner.name}
            data-partner-card
            data-col={index}
            class={`partner-card group relative rounded-2xl border border-neutral-200 bg-white p-6 shadow-sm transition-all duration-500 hover:-translate-y-2 hover:border-[#C48356]/30 hover:shadow-xl md:p-10 ${
              isThirdOfThree ? "col-span-2 md:col-span-1" : ""
            }`}
          >
            {/* Logo Container */}
            <div class="mb-5 flex h-24 items-center justify-center md:mb-6 md:h-32">
              <img
                src={partner.logo}
                alt={partner.name}
                class="max-h-full w-auto max-w-full scale-100 object-contain opacity-80 transition-all duration-500 group-hover:scale-110 group-hover:opacity-100"
                loading="lazy"
                decoding="async"
              />
            </div>

            {/* Partner Info */}
            <div class="text-center">
              <h3 class="mb-2 text-base font-semibold text-neutral-900 md:text-lg">
                {partner.name}
              </h3>

              {partner.description && (
                <p class="text-sm text-neutral-600">{partner.description}</p>
              )}
            </div>

            {/* Hover Arrow */}
            <div class="absolute right-4 top-4 flex h-8 w-8 items-center justify-center rounded-full bg-[#C48356]/0 opacity-0 transition-all duration-500 group-hover:bg-[#C48356]/10 group-hover:opacity-100">
              <svg
                class="h-4 w-4 text-[#C48356]"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
                />
              </svg>
            </div>

            {/* Bottom accent line */}
            <div class="absolute bottom-0 left-0 right-0 h-1 origin-left scale-x-0 rounded-b-2xl bg-gradient-to-r from-[#C48356] to-[#B47347] transition-transform duration-500 group-hover:scale-x-100" />
          </a>
        );
      })}
    </div>

    {/* Trust Statement */}
    <div class="mt-16 text-center">
      <p class="mx-auto max-w-3xl leading-relaxed text-neutral-600">
        Our partnerships with these industry leaders ensure you receive{" "}
        <span class="font-semibold text-[#C48356]">premium materials</span>,{" "}
        <span class="font-semibold text-[#C48356]">expert support</span>, and{" "}
        <span class="font-semibold text-[#C48356]">guaranteed quality</span> on
        every project.
      </p>
    </div>
  </div>

<script is:inline>
  (() => {
    document.documentElement.classList.add("js");

    const grid = document.getElementById("partners-grid");
    if (!grid) return;

    // ✅ Only grab cards inside THIS grid (prevents collisions with other sections)
    let cards = Array.from(grid.querySelectorAll("[data-partner-card]"));

    if (!cards.length) return;

    // Right → Left (2,1,0) like you wanted originally
    cards = cards.sort((a, b) => Number(b.dataset.col || 0) - Number(a.dataset.col || 0));

    const prefersReduced = window.matchMedia("(prefers-reduced-motion: reduce)").matches;
    if (prefersReduced) {
      cards.forEach((c) => c.classList.add("is-in"));
      return;
    }

    const sleep = (ms) => new Promise((r) => setTimeout(r, ms));

    const animateIn = async (el) => {
      // Force initial state to apply
      el.getBoundingClientRect();

      // WAAPI (reliable) if available
      if (el.animate) {
        const anim = el.animate(
          [
            { opacity: 0, transform: "translateX(-120%)" },
            { opacity: 1, transform: "translateX(0)" },
          ],
          {
            duration: 650,
            easing: "cubic-bezier(.2,.8,.2,1)",
            fill: "forwards",
          }
        );

        await anim.finished.catch(() => {});
        el.classList.add("is-in");
        el.style.opacity = "";
        el.style.transform = "";
        return;
      }

      // Fallback
      el.classList.add("is-in");
      await sleep(700);
    };

    const runSequence = async () => {
      for (const card of cards) {
        await animateIn(card);
        await sleep(90);
      }
    };

    let hasRun = false;

    const io = new IntersectionObserver(
      (entries) => {
        if (hasRun) return;
        if (entries.some((e) => e.isIntersecting)) {
          hasRun = true;
          runSequence();
          io.disconnect();
        }
      },
      { threshold: 0.15, rootMargin: "0px 0px -10% 0px" }
    );

    // ✅ Key fix: wait one frame so html.js + CSS hidden state is “real” first
    requestAnimationFrame(() => {
      io.observe(grid);
    });
  })();
</script>


</section>

<style>
  /* ✅ Visible by default (if JS fails, users still see cards) */
  .partner-card {
    opacity: 1;
    transform: none;
    transition: opacity 650ms ease, transform 650ms cubic-bezier(.2,.8,.2,1);
    will-change: opacity, transform;
  }

  /* ✅ Only hide/animate when JS is enabled */
  html.js .partner-card {
    opacity: 0;
    transform: translateX(-120%);
  }

  html.js .partner-card.is-in {
    opacity: 1;
    transform: translateX(0);
  }

  /* Slightly tighter grid spacing on small screens */
  @media (max-width: 480px) {
    #partners-grid {
      gap: 0.9rem;
    }
  }

  /* Ensure logos don't get too large on very big screens */
  @media (min-width: 1536px) {
    .partner-card img {
      max-height: 140px;
    }
  }
</style>
