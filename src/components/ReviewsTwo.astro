---
type Review = {
  author_name: string;
  author_url: string | null;
  profile_photo_url: string | null;
  rating: number | null;
  relative_time_description: string;
  text: string;
};

type ReviewsPayload = {
  rating: number | null;
  count: number | null;
  reviews: Review[];
  error?: string;
  status?: string;
  message?: string;
  missing?: string[];
};

let payload: ReviewsPayload | null = null;
let errorMsg: string | null = null;

try {
  const res = await fetch(new URL("/api/reviews", Astro.url.origin), {
    headers: { accept: "application/json" },
  });

  const contentType = res.headers.get("content-type") || "";
  const raw = await res.text();

  if (!res.ok) {
    throw new Error(`API ${res.status} ${res.statusText}: ${raw.slice(0, 250)}`);
  }
  if (!contentType.includes("application/json")) {
    throw new Error(
      `Expected JSON, got ${contentType || "(none)"}. Body: ${raw.slice(0, 120)}`
    );
  }

  payload = JSON.parse(raw) as ReviewsPayload;

  if (payload?.error) {
    errorMsg =
      payload.message ||
      payload.error ||
      `Google reviews error${payload.status ? `: ${payload.status}` : ""}`;
  }
} catch (e: any) {
  errorMsg = e?.message ?? String(e);
}

const rating = payload?.rating ?? null;
const count = payload?.count ?? null;

const reviews: Review[] = Array.isArray(payload?.reviews)
  ? payload!.reviews.slice(0, 5)
  : [];

const summaryStars = Math.min(5, Math.max(0, Math.round(rating ?? 0)));
---

<section class="bg-gradient-to-b from-neutral-50 to-white py-14 md:py-20">
  <div class="mx-auto max-w-7xl px-6">
    <div class="mb-8 text-center">
      <h2 class="text-4xl md:text-5xl font-bold text-neutral-900 tracking-tight">
        Trusted by MN Homeowners
      </h2>
      <p class="mt-4 text-lg text-neutral-600 max-w-2xl mx-auto">
        See what homeowners are saying about working with our team
      </p>
    </div>

    {/* Error banner (never blank now) */}
    {(errorMsg || payload?.missing?.length) && (
      <div class="mx-auto mb-10 max-w-3xl rounded-2xl border border-red-200 bg-red-50 px-5 py-4 text-sm text-red-800">
        <p class="font-semibold">Reviews aren’t available right now.</p>
        {errorMsg && <p class="mt-1 opacity-90">{errorMsg}</p>}
        {payload?.missing?.length ? (
          <p class="mt-2 text-xs opacity-80">
            Missing: {payload.missing.join(", ")}
          </p>
        ) : null}
      </div>
    )}

    {/* Summary */}
    {!errorMsg && (rating !== null || count !== null) && (
      <div class="mb-10 flex flex-col items-center gap-2">
        {rating !== null && (
          <div
            class="flex items-center gap-3"
            itemscope
            itemtype="https://schema.org/AggregateRating"
          >
            <meta itemprop="ratingValue" content={String(rating)} />
            {count !== null && <meta itemprop="ratingCount" content={String(count)} />}

            <span class="text-3xl font-bold text-neutral-900">
              {rating.toFixed(1)}
            </span>
            <div class="text-yellow-400 text-lg leading-none">
              {"★".repeat(summaryStars)}
              <span class="text-neutral-300">
                {"★".repeat(Math.max(0, 5 - summaryStars))}
              </span>
            </div>
          </div>
        )}

        {count !== null && (
          <p class="text-sm text-neutral-600">
            Based on {count.toLocaleString()} Google reviews
          </p>
        )}
      </div>
    )}

    {/* Empty state */}
    {!errorMsg && reviews.length === 0 && (
      <p class="mx-auto max-w-3xl text-center text-sm text-neutral-500">
        Reviews will appear here once Google returns them.
      </p>
    )}

    {/* ✅ Review cards — horizontal rail layout */}
    {reviews.length > 0 && (
      <div class="relative">
        <div
          class="mx-auto max-w-7xl flex gap-5 md:gap-6
                 overflow-x-auto pb-6 px-1
                 snap-x snap-mandatory"
          aria-label="Customer reviews"
        >
          {reviews.map((r: Review) => {
            const rStars = Math.min(5, Math.max(0, r.rating ?? 0));
            return (
              <article
                class="group w-80 md:w-96 shrink-0 snap-start
                       rounded-3xl bg-white p-8 shadow-lg
                       ring-1 ring-neutral-200/70
                       hover:shadow-2xl hover:ring-[#C48356]/30
                       transition-all duration-300 hover:-translate-y-1"
                itemscope
                itemtype="https://schema.org/Review"
              >
                {/* Author row */}
                <div class="flex items-center gap-4 mb-4">
                  <div class="flex h-12 w-12 items-center justify-center rounded-full bg-neutral-100 overflow-hidden">
                    {r.profile_photo_url ? (
                      <img
                        src={r.profile_photo_url}
                        alt={r.author_name}
                        class="h-full w-full object-cover"
                        loading="lazy"
                        decoding="async"
                        referrerpolicy="no-referrer"
                      />
                    ) : (
                      <div class="flex h-full w-full items-center justify-center bg-gradient-to-br from-[#C48356] to-[#B47347] text-white font-bold text-lg shadow-md">
                        {(r.author_name?.[0] ?? "G").toUpperCase()}
                      </div>
                    )}
                  </div>

                  <div class="min-w-0 flex-1">
                    <div class="truncate font-semibold text-neutral-900" itemprop="author">
                      {r.author_name ?? "Google User"}
                    </div>
                    <time class="text-xs text-neutral-500" itemprop="datePublished">
                      {r.relative_time_description ?? ""}
                    </time>
                  </div>
                </div>

                {/* Rating */}
                <div
                  class="flex gap-1 mb-4"
                  itemprop="reviewRating"
                  itemscope
                  itemtype="https://schema.org/Rating"
                >
                  <meta itemprop="ratingValue" content={String(rStars)} />
                  <meta itemprop="bestRating" content="5" />

                  {Array.from({ length: 5 }).map((_, i) => (
                    <svg
                      viewBox="0 0 20 20"
                      class={`h-5 w-5 ${i < rStars ? "fill-[#C48356]" : "fill-neutral-300"}`}
                      aria-hidden="true"
                    >
                      <path d="m10 15.27 5.18 3.05-1.64-5.81 4.46-3.86-5.86-.5L10 2 7.86 8.15l-5.86.5 4.46 3.86-1.64 5.81L10 15.27z" />
                    </svg>
                  ))}
                </div>

                {/* Body */}
                <p
                  class="text-sm text-neutral-700 leading-relaxed line-clamp-6"
                  itemprop="reviewBody"
                >
                  {r.text ?? ""}
                </p>

                {/* Link */}
                {r.author_url && (
                  <a
                    href={r.author_url}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="mt-4 inline-flex text-xs font-semibold text-neutral-500 hover:text-[#C48356] transition"
                  >
                    View on Google →
                  </a>
                )}
              </article>
            );
          })}
        </div>

        {/* Fade edges (polish) */}
        <div class="pointer-events-none absolute inset-y-0 left-0 w-10 bg-gradient-to-r from-white to-transparent"></div>
        <div class="pointer-events-none absolute inset-y-0 right-0 w-10 bg-gradient-to-l from-white to-transparent"></div>
      </div>
    )}

    <p class="mt-8 text-center text-xs text-neutral-400">
      Reviews are provided by Google and refresh automatically.
    </p>
  </div>
</section>
